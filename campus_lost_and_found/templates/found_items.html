<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>招领物品列表</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 加载遮罩层样式 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* 图片默认样式 */
        .default-image {
            height: 200px;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        .card-img-container {
            height: 200px;
            overflow: hidden;
            position: relative;
        }
        .card-img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        /* 改进的按钮样式 */
        .btn-match {
            position: relative;
            overflow: hidden;
        }
        .btn-match:hover {
            transform: translateY(-2px);
            transition: transform 0.2s;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <nav class="navbar navbar-light bg-white rounded shadow mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    ← 返回首页
                </a>
                <div>
                    <a href="/submit/found" class="btn btn-success">提交招领</a>
                    <a href="/lost" class="btn btn-outline-success ms-2">查看丢失</a>
                    <a href="/match" class="btn btn-primary ms-2">智能匹配</a>
                </div>
            </div>
        </nav>

        <h2 class="mb-4">招领物品列表</h2>

        {% if items %}
            <div class="row">
                {% for item in items %}
                <div class="col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-img-container">
                            {% if item.image_url %}
                                {% if item.image_url.startswith('http') or item.image_url.startswith('/uploads/') %}
                                    <img src="{{ item.image_url }}"
                                         alt="{{ item.title }}"
                                         loading="lazy"
                                         class="item-image"
                                         data-item-id="{{ item.id }}"
                                         data-item-title="{{ item.title }}">
                                {% else %}
                                    <!-- 尝试从uploads目录加载 -->
                                    <img src="{{ url_for('uploaded_file', filename=item.image_url.split('/')[-1]) if item.image_url else '' }}"
                                         alt="{{ item.title }}"
                                         loading="lazy"
                                         class="item-image"
                                         data-item-id="{{ item.id }}"
                                         data-item-title="{{ item.title }}">
                                {% endif %}
                            {% else %}
                                <div class="default-image w-100 h-100">
                                    <div class="text-center">
                                        <span style="font-size: 3rem;">📷</span>
                                        <p class="mt-2">无图片</p>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ item.title }}</h5>
                            <p class="card-text">{{ item.description }}</p>
                            <p class="text-muted mb-1">
                                <small>拾获地点：{{ item.found_location }}</small>
                            </p>
                            <p class="text-muted mb-1">
                                <small>拾获时间：{{ item.found_date }}</small>
                            </p>
                            <p class="text-muted mb-0">
                                <small>联系方式：{{ item.contact_phone }}</small>
                            </p>
                            {% if item.contact_name %}
                            <p class="text-muted mb-0">
                                <small>联系人：{{ item.contact_name }}</small>
                            </p>
                            {% endif %}
                            {% if item.category %}
                            <p class="text-muted mb-0">
                                <small>类别：{{ item.category }}</small>
                            </p>
                            {% endif %}
                        </div>
                        <div class="card-footer bg-transparent">
                            <small class="text-muted">物品ID: {{ item.id }}</small>
                            <button class="btn btn-sm btn-primary float-end btn-match"
                                    onclick="matchItem('{{ item.id }}', '{{ item.title }}')">
                                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                AI匹配丢失物品
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

        {% else %}
            <div class="text-center py-5">
                <h3>暂无招领物品</h3>
                <p class="text-muted">还没有人提交招领物品</p>
                <a href="/submit/found" class="btn btn-success">提交第一个招领</a>
            </div>
        {% endif %}
    </div>

    <!-- 加载遮罩层 -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
            <h5 class="mt-3">AI正在匹配中...</h5>
            <p>正在为您查找相似的丢失物品</p>
        </div>
    </div>

    <!-- 匹配结果弹窗 -->
    <div class="modal fade" id="matchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="matchModalTitle">匹配结果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="matchResultsContent">
                        <!-- 结果会动态填充到这里 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <a href="/match" class="btn btn-primary">前往智能匹配页面</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
    let matchModal = null;
    let currentItemName = '';

    // 等待DOM完全加载
    document.addEventListener('DOMContentLoaded', function() {
        console.log('页面加载完成，开始初始化...');

        // 1. 检查Bootstrap是否加载
        if (typeof bootstrap === 'undefined') {
            console.error('错误：Bootstrap未加载！');
            alert('页面资源加载失败，请刷新页面');
            return;
        }

        // 2. 检查Modal元素是否存在
        const modalElement = document.getElementById('matchModal');
        if (!modalElement) {
            console.error('错误：找不到matchModal元素');
            return;
        }

        // 3. 初始化Modal
        try {
            matchModal = new bootstrap.Modal(modalElement);
            console.log('弹窗初始化成功');
        } catch (error) {
            console.error('弹窗初始化失败:', error);
            alert('页面初始化失败，请刷新');
            return;
        }

        // 4. 设置图片错误处理
        document.querySelectorAll('.item-image').forEach(img => {
            img.onerror = function() {
                console.log('图片加载失败:', this.src);
                this.style.display = 'none';
                const parent = this.parentElement;
                parent.innerHTML = `
                    <div class="default-image w-100 h-100">
                        <div class="text-center">
                            <span style="font-size: 3rem;">📷</span>
                            <p class="mt-2">图片加载失败</p>
                        </div>
                    </div>
                `;
            };

            // 添加点击查看大图功能
            img.onclick = function() {
                const src = this.src;
                if (src && !src.includes('#')) {
                    const modalHtml = `
                        <div class="modal fade" id="imageModal" tabindex="-1">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-body text-center">
                                        <img src="${src}" class="img-fluid" alt="物品图片">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    const container = document.createElement('div');
                    container.innerHTML = modalHtml;
                    document.body.appendChild(container);
                    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
                    imageModal.show();
                    document.getElementById('imageModal').addEventListener('hidden.bs.modal', function() {
                        container.remove();
                    });
                }
            };
            img.style.cursor = 'pointer';
        });

        console.log('页面初始化完成');
    });

    async function matchItem(itemId, itemName) {
        console.log('开始匹配，itemId:', itemId, 'itemName:', itemName);
        currentItemName = itemName;

        // 检查弹窗是否初始化
        if (!matchModal) {
            console.error('弹窗未初始化');
            alert('页面未完全加载，请刷新后重试');
            return;
        }

        // 显示加载动画
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.classList.remove('d-none');
        }

        // 禁用按钮并显示加载状态
        const buttons = document.querySelectorAll(`[onclick*="${itemId}"]`);
        buttons.forEach(btn => {
            btn.disabled = true;
            const spinner = btn.querySelector('.spinner-border');
            if (spinner) spinner.classList.remove('d-none');
        });

        try {
            console.log('发送匹配请求...');

            const requestBody = {
                found_item_id: itemId
            };

            console.log('请求体:', requestBody);

            const response = await fetch('/api/match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            console.log('响应状态:', response.status);

            const data = await response.json();
            console.log('响应数据:', data);

            // 隐藏加载动画
            if (loadingOverlay) {
                loadingOverlay.classList.add('d-none');
            }

            // 恢复按钮状态
            buttons.forEach(btn => {
                btn.disabled = false;
                const spinner = btn.querySelector('.spinner-border');
                if (spinner) spinner.classList.add('d-none');
            });

            if (data.error) {
                console.error('后端错误:', data.error);
<!--                if (data.error.includes('物品不存在')) {-->
<!--                    await showRecommendedLostItems(itemId);-->
<!--                } else {-->
<!--                    throw new Error(data.error);-->
<!--                }-->
            } else {
                // 显示匹配结果
                showMatchResults(data);
            }

        } catch (error) {
            // 隐藏加载动画
            if (loadingOverlay) {
                loadingOverlay.classList.add('d-none');
            }

            // 恢复按钮状态
            buttons.forEach(btn => {
                btn.disabled = false;
                const spinner = btn.querySelector('.spinner-border');
                if (spinner) spinner.classList.add('d-none');
            });

            console.error('匹配失败:', error);
            alert('匹配失败: ' + error.message);
        }
    }

    function showMatchResults(data) {
        console.log('显示匹配结果，数据:', data);

        const content = document.getElementById('matchResultsContent');
        if (!content) {
            console.error('错误：找不到matchResultsContent元素');
            return;
        }

        if (!matchModal) {
            console.error('错误：matchModal未初始化');
            alert('弹窗未初始化');
            return;
        }

        // 更新Modal标题
        const modalTitle = document.getElementById('matchModalTitle');
        if (modalTitle) {
            modalTitle.textContent = `"${currentItemName}" 的匹配结果`;
        }

        if (data.success && data.matches && data.matches.length > 0) {
            // 新结构：多个匹配项
            let html = `
                <div class="alert alert-info">
                    <h6><i class="bi bi-search"></i> 匹配完成</h6>
                    <p><strong>找到 ${data.total_matches} 个可能匹配的丢失物品</strong></p>
                    <small class="text-muted">点击"查看匹配详情"可以查看详细信息并进行联系</small>
                </div>
            `;

            // 显示前3个匹配结果
            data.matches.slice(0, 3).forEach((match, index) => {
                const matchResult = match.match_result || {};
                const analysis = matchResult.qianwen_analysis || '无AI分析';
                const lostItemId = match.lost_item ? match.lost_item.id : '';
                const foundItemId = match.found_item ? match.found_item.id : '';

                html += `
                    <div class="card mb-3 ${matchResult.match_score > 70 ? 'border-success' : 'border-warning'}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6><i class="bi bi-check-circle"></i> 匹配项 ${index + 1}</h6>
                                <span class="badge ${matchResult.match_score > 70 ? 'bg-success' : 'bg-warning'}">
                                    ${matchResult.match_score || 0}/100
                                </span>
                            </div>
                            <p><strong>${escapeHtml(match.lost_item.title)}</strong></p>
                            <p class="text-muted">${escapeHtml(match.lost_item.description)}</p>
                            <p><small><i class="bi bi-geo-alt"></i> ${escapeHtml(match.lost_item.lost_location)}</small></p>
                            <p><small><i class="bi bi-calendar"></i> ${escapeHtml(match.lost_item.lost_date)}</small></p>

                            <div class="mt-2 mb-3">
                                <small class="text-muted">匹配等级：${matchResult.match_level || '未知'}</small>
                                <br>
                                <small class="text-muted">AI分析：${escapeHtml(analysis.substring(0, 100))}...</small>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="viewItemDetail('${escapeHtml(lostItemId)}', 'lost')">
                                    <i class="bi bi-eye"></i> 查看丢失物品详情
                                </button>
                                <button class="btn btn-sm btn-primary"
                                        onclick="viewMatchDetails('${escapeHtml(lostItemId)}', '${escapeHtml(foundItemId)}', '${escapeHtml(currentItemName)}')">
                                    <i class="bi bi-arrow-right-circle"></i> 查看匹配详情
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            // 如果有更多匹配项
            if (data.total_matches > 3) {
                html += `
                    <div class="alert alert-light">
                        <p class="mb-0">还有 ${data.total_matches - 3} 个匹配项未显示</p>
                        <small class="text-muted">前往智能匹配页面查看更多匹配结果</small>
                    </div>
                `;
            }

            content.innerHTML = html;
        } else {
            content.innerHTML = `
                <div class="text-center py-4">
                    <h5><i class="bi bi-emoji-frown"></i> 未找到匹配的丢失物品</h5>
                    <p class="text-muted">暂时没有找到相似的丢失物品记录。</p>
                    <div class="mt-3">
                        <a href="/match" class="btn btn-primary">前往智能匹配页面</a>
                    </div>
                </div>
            `;
        }

        // 显示Modal
        try {
            matchModal.show();
            console.log('弹窗显示成功');
        } catch (error) {
            console.error('显示弹窗失败:', error);
            alert('显示结果时出错: ' + error.message);
        }
    }

    // ==================== 新增功能函数 ====================

    // 1. 查看物品详情
    function viewItemDetail(itemId, itemType) {
    console.log('查看物品详情:', itemId, itemType);

    // 先关闭当前弹窗
    if (matchModal) {
        matchModal.hide();
    }

    // 统一使用弹窗显示详情
    setTimeout(() => {
        // 获取物品详情并显示弹窗
        fetch(`/api/item/${itemId}`)
            .then(response => response.json())
            .then(data => {
                if (data.item) {
                    // 使用API返回的type或传入的type
                    const actualType = data.type || itemType;
                    showItemDetailModal(data.item, actualType);
                } else {
                    alert('无法获取物品详情');
                }
            })
            .catch(err => {
                console.error('获取物品详情失败:', err);
                alert('获取详情失败: ' + err.message);
            });
    }, 300);
}

    // 2. 查看匹配详情（跳转到智能匹配页面）
    function viewMatchDetails(lostItemId, foundItemId, foundItemTitle) {
        console.log('查看匹配详情:', lostItemId, foundItemId);

        // 先关闭当前弹窗
        if (matchModal) {
            matchModal.hide();
        }

        // 保存到localStorage，跳转到智能匹配页面
        setTimeout(() => {
            // 确保传递了所有必要参数
            if (lostItemId && lostItemId !== 'undefined') {
                localStorage.setItem('preselectedLostId', lostItemId);
            }
            if (foundItemId && foundItemId !== 'undefined') {
                localStorage.setItem('preselectedFoundId', foundItemId);
            }
            if (foundItemTitle && foundItemTitle !== 'undefined') {
                localStorage.setItem('preselectedTitle', foundItemTitle);
            }

            window.location.href = '/match';
        }, 300);
    }

    // 3. 显示物品详情弹窗（接收item对象）
function showItemDetailModal(item, itemType) {
    console.log('显示物品详情弹窗:', item, itemType);

    if (!item || !item.id) {
        console.error('物品数据无效:', item);
        alert('物品数据无效，无法显示详情');
        return;
    }

    const modalTitle = itemType === 'lost' ? '丢失物品详情' : '招领物品详情';
    const headerClass = itemType === 'lost' ? 'bg-danger' : 'bg-success';

    const detailHtml = `
        <div class="modal fade" id="itemDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header ${headerClass} text-white">
                        <h5 class="modal-title">${modalTitle}</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h4>${escapeHtml(item.title || '无标题')}</h4>
                        <p class="text-muted">${escapeHtml(item.description || '无描述')}</p>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>基本信息</h6>
                                <ul class="list-unstyled">
                                    <li><strong>类别：</strong> ${escapeHtml(item.category || '未分类')}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>${itemType === 'lost' ? '丢失信息' : '拾获信息'}</h6>
                                <ul class="list-unstyled">
                                    <li><strong>${itemType === 'lost' ? '丢失' : '拾获'}地点：</strong>
                                        ${escapeHtml(itemType === 'lost' ? item.lost_location : item.found_location || '未提供')}
                                    </li>
                                    <li><strong>${itemType === 'lost' ? '丢失' : '拾获'}时间：</strong>
                                        ${escapeHtml(itemType === 'lost' ? item.lost_date : item.found_date || '未提供')}
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-3">
                            <h6>联系方式</h6>
                            <ul class="list-unstyled">
                                <li><strong>联系人：</strong> ${escapeHtml(item.contact_name || '未提供')}</li>
                                <li><strong>电话：</strong> ${escapeHtml(item.contact_phone || '未提供')}</li>
                            </ul>
                        </div>

                        ${item.image_url ?
                            `<div class="mt-3 text-center">
                                <img src="${item.image_url}" class="img-fluid rounded" style="max-height: 300px;" alt="${escapeHtml(item.title || '物品图片')}">
                            </div>` :
                            `<div class="mt-3 text-center text-muted">
                                <div style="font-size: 4rem;">📷</div>
                                <p>暂无图片</p>
                            </div>`
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        ${itemType === 'found' && item.contact_phone ?
                            `<button class="btn btn-success" onclick="contactOwner('${escapeHtml(item.contact_phone)}', '${escapeHtml(item.contact_name || '')}')">
                                联系认领
                            </button>` :
                            ''
                        }
                    </div>
                </div>
            </div>
        </div>
    `;

    // 创建并显示弹窗
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = detailHtml;
    document.body.appendChild(modalContainer);

    try {
        const itemModal = new bootstrap.Modal(document.getElementById('itemDetailModal'));
        itemModal.show();

        // 清理
        document.getElementById('itemDetailModal').addEventListener('hidden.bs.modal', function () {
            modalContainer.remove();
        });
    } catch (error) {
        console.error('显示弹窗失败:', error);
        alert('显示详情失败: ' + error.message);
        modalContainer.remove();
    }
}
    // 4. 联系对方
    function contactOwner(phone, name) {
        if (!phone) {
            alert('对方未提供联系方式');
            return;
        }

        const contactMsg = `联系人：${name || '匿名'}\n电话：${phone}`;

        if (confirm(`是否联系对方？\n\n${contactMsg}\n\n确定将复制电话号码到剪贴板`)) {
            // 复制到剪贴板
            navigator.clipboard.writeText(phone)
                .then(() => {
                    alert(`电话号码已复制到剪贴板：${phone}\n\n请使用电话或短信联系对方`);
                })
                .catch(err => {
                    console.error('复制失败:', err);
                    alert(`联系方式：${phone}\n\n请手动记录电话号码`);
                });
        }
    }

    // 5. 匹配当前物品（修正版本）
    function matchThisItem(itemId, itemTitle) {
        console.log('匹配物品:', itemId, itemTitle);

        // 先关闭详情弹窗
        const detailModalElement = document.getElementById('itemDetailModal');
        if (detailModalElement) {
            const detailModal = bootstrap.Modal.getInstance(detailModalElement);
            if (detailModal) {
                detailModal.hide();
            }
        }

        // 延迟后调用匹配函数
        setTimeout(() => {
            matchItem(itemId, itemTitle);
        }, 500);
    }

    // HTML转义函数
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    </script>
</body>
</html>