<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åŒ¹é…</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .similarity-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .similarity-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd166, #06d6a0);
            transition: width 0.5s ease;
        }

        .match-card {
            transition: all 0.3s ease;
            border-left: 4px solid #0d6efd;
        }

        .bi {
            vertical-align: -.125em;
        }

        .top-navbar {
            margin-bottom: 1.5rem;
        }
        .nav-back {
            text-decoration: none;
            color: #0d6efd;
        }
        .nav-back:hover {
            text-decoration: underline;
        }
        .selected-item {
            background: #f8f9fa;
            border: 2px solid #0d6efd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .selected-item h6 {
            color: #0d6efd;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <nav class="navbar navbar-expand-lg navbar-light bg-white rounded shadow top-navbar">
            <div class="container-fluid">
                <a class="navbar-brand nav-back" href="/">
                    <i class="bi bi-arrow-left"></i> è¿”å›é¦–é¡µ
                </a>
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <a href="/lost" class="btn btn-outline-danger btn-sm me-2">
                            <i class="bi bi-search"></i> ä¸¢å¤±ç‰©å“
                        </a>
                        <a href="/found" class="btn btn-outline-success btn-sm me-2">
                            <i class="bi bi-eye"></i> æ‹›é¢†ç‰©å“
                        </a>
                    </div>
                    <span class="navbar-text text-muted">
                        <i class="bi bi-cpu"></i> AIæ™ºèƒ½åŒ¹é…
                    </span>
                </div>
            </div>
        </nav>
    </div>

    <div class="container mt-2">
        <h2 class="mb-4"><i class="bi bi-graph-up"></i> æ™ºèƒ½åŒ¹é…ç³»ç»Ÿ</h2>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-sliders"></i> åŒ¹é…è®¾ç½®
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="lostItemSelect" class="form-label">
                                <i class="bi bi-exclamation-triangle text-danger"></i> é€‰æ‹©ä¸¢å¤±ç‰©å“
                            </label>
                            <select class="form-select" id="lostItemSelect">
                                <option value="">è¯·é€‰æ‹©ä¸¢å¤±ç‰©å“...</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="foundItemSelect" class="form-label">
                                <i class="bi bi-hand-thumbs-up text-success"></i> é€‰æ‹©æ‹›é¢†ç‰©å“
                            </label>
                            <select class="form-select" id="foundItemSelect">
                                <option value="">è¯·é€‰æ‹©æ‹›é¢†ç‰©å“...</option>
                            </select>
                        </div>

                        <div id="selectedItems" class="d-none">
                            <!-- é€‰ä¸­çš„ç‰©å“ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>

                        <button id="matchBtn" class="btn btn-primary w-100" disabled>
                            <span class="spinner-border spinner-border-sm d-none" id="matchSpinner"></span>
                            <i class="bi bi-lightning"></i> å¼€å§‹åŒ¹é…
                        </button>

                        <div class="mt-3 d-grid gap-2">
                            <a href="/lost" class="btn btn-outline-danger">
                                <i class="bi bi-search"></i> æŸ¥çœ‹æ‰€æœ‰ä¸¢å¤±ç‰©å“
                            </a>
                            <a href="/found" class="btn btn-outline-success">
                                <i class="bi bi-eye"></i> æŸ¥çœ‹æ‰€æœ‰æ‹›é¢†ç‰©å“
                            </a>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i> åŒ¹é…è¯´æ˜
                    </div>
                    <div class="card-body">
                        <p><strong><i class="bi bi-star"></i> åŒ¹é…æ­¥éª¤ï¼š</strong></p>
                        <ol class="mb-3">
                            <li>é€‰æ‹©ä¸€ä¸ªä¸¢å¤±ç‰©å“</li>
                            <li>é€‰æ‹©ä¸€ä¸ªæ‹›é¢†ç‰©å“</li>
                            <li>ç‚¹å‡»"å¼€å§‹åŒ¹é…"</li>
                            <li>æŸ¥çœ‹åŒ¹é…ç»“æœ</li>
                        </ol>
                        <p class="mb-0"><small class="text-muted">ç³»ç»Ÿä¼šæ¯”è¾ƒä¸¤ä¸ªç‰©å“çš„ç‰¹å¾å¹¶ç»™å‡ºåŒ¹é…åˆ†æ•°</small></p>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-list-check"></i> åŒ¹é…ç»“æœ
                    </div>
                    <div class="card-body">
                        <!-- åŠ è½½çŠ¶æ€ -->
                        <div id="loading" class="text-center d-none">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                            <p class="mt-3"><i class="bi bi-robot"></i> AIæ­£åœ¨åˆ†æåŒ¹é…...</p>
                            <p class="text-muted">è¯·ç¨å€™ï¼Œç³»ç»Ÿæ­£åœ¨è®¡ç®—ç›¸ä¼¼åº¦</p>
                        </div>

                        <!-- åˆå§‹çŠ¶æ€ -->
                        <div id="noSelection" class="text-center">
                            <i class="bi bi-search display-1 text-muted"></i>
                            <h5 class="mt-3">è¯·é€‰æ‹©ä¸¤ä¸ªç‰©å“å¼€å§‹åŒ¹é…</h5>
                            <p class="text-muted">å·¦ä¾§é€‰æ‹©ä¸€ä¸ªä¸¢å¤±ç‰©å“å’Œä¸€ä¸ªæ‹›é¢†ç‰©å“è¿›è¡ŒåŒ¹é…</p>
                        </div>

                        <!-- åŒ¹é…ç»“æœ -->
                        <div id="matchResults" class="d-none">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5><i class="bi bi-check-circle"></i> åŒ¹é…å®Œæˆ</h5>
                                <button class="btn btn-outline-secondary btn-sm" onclick="resetMatch()">
                                    <i class="bi bi-arrow-clockwise"></i> é‡æ–°åŒ¹é…
                                </button>
                            </div>

                            <!-- åŒ¹é…è¯¦æƒ… -->
                            <div id="matchDetails"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const lostItemSelect = document.getElementById('lostItemSelect');
            const foundItemSelect = document.getElementById('foundItemSelect');
            const selectedItemsDiv = document.getElementById('selectedItems');
            const matchBtn = document.getElementById('matchBtn');
            const matchSpinner = document.getElementById('matchSpinner');
            const loading = document.getElementById('loading');
            const noSelection = document.getElementById('noSelection');
            const matchResults = document.getElementById('matchResults');
            const matchDetails = document.getElementById('matchDetails');

            let selectedLostItem = null;
            let selectedFoundItem = null;
            let lostItemsCache = [];
            let foundItemsCache = [];

            // é‡ç½®åŒ¹é…çŠ¶æ€
            function resetMatch() {
                lostItemSelect.value = '';
                foundItemSelect.value = '';
                selectedLostItem = null;
                selectedFoundItem = null;
                selectedItemsDiv.classList.add('d-none');
                selectedItemsDiv.innerHTML = '';
                matchBtn.disabled = true;
                noSelection.classList.remove('d-none');
                matchResults.classList.add('d-none');
                loading.classList.add('d-none');
            }

            // åŠ è½½ç‰©å“åˆ—è¡¨
            async function loadItems() {
                try {
                    // åŒæ—¶åŠ è½½ä¸¢å¤±å’Œæ‹›é¢†ç‰©å“
                    const [lostResponse, foundResponse] = await Promise.all([
                        fetch('/api/items/lost'),
                        fetch('/api/items/found')
                    ]);

                    if (!lostResponse.ok || !foundResponse.ok) {
                        throw new Error('åŠ è½½ç‰©å“å¤±è´¥');
                    }

                    const lostData = await lostResponse.json();
                    const foundData = await foundResponse.json();

                    lostItemsCache = lostData.items || [];
                    foundItemsCache = foundData.items || [];

                    // å¡«å……ä¸¢å¤±ç‰©å“ä¸‹æ‹‰æ¡†
                    lostItemSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä¸¢å¤±ç‰©å“...</option>';
                    if (lostItemsCache.length > 0) {
                        lostItemsCache.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = `${item.title} - ${item.lost_location} (${item.lost_date || 'æ— æ—¥æœŸ'})`;
                            lostItemSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "æš‚æ— ä¸¢å¤±ç‰©å“";
                        option.disabled = true;
                        lostItemSelect.appendChild(option);
                    }

                    // å¡«å……æ‹›é¢†ç‰©å“ä¸‹æ‹‰æ¡†
                    foundItemSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ‹›é¢†ç‰©å“...</option>';
                    if (foundItemsCache.length > 0) {
                        foundItemsCache.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.id;
                            option.textContent = `${item.title} - ${item.found_location} (${item.found_date || 'æ— æ—¥æœŸ'})`;
                            foundItemSelect.appendChild(option);
                        });
                    } else {
                        const option = document.createElement('option');
                        option.value = "";
                        option.textContent = "æš‚æ— æ‹›é¢†ç‰©å“";
                        option.disabled = true;
                        foundItemSelect.appendChild(option);
                    }

                } catch (error) {
                    console.error('åŠ è½½ç‰©å“å¤±è´¥:', error);
                    lostItemSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</option>';
                    foundItemSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢</option>';
                }
            }

            // æ˜¾ç¤ºé€‰ä¸­çš„ç‰©å“
            function displaySelectedItems() {
                if (selectedLostItem && selectedFoundItem) {
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <div class="selected-item">
                                    <h6><i class="bi bi-exclamation-triangle text-danger"></i> ä¸¢å¤±ç‰©å“</h6>
                                    <p><strong>${escapeHtml(selectedLostItem.title)}</strong></p>
                                    <p class="text-muted mb-1">${escapeHtml(selectedLostItem.description || 'æ— æè¿°')}</p>
                                    <p class="mb-1"><small><i class="bi bi-geo-alt"></i> ${escapeHtml(selectedLostItem.lost_location)}</small></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="selected-item">
                                    <h6><i class="bi bi-hand-thumbs-up text-success"></i> æ‹›é¢†ç‰©å“</h6>
                                    <p><strong>${escapeHtml(selectedFoundItem.title)}</strong></p>
                                    <p class="text-muted mb-1">${escapeHtml(selectedFoundItem.description || 'æ— æè¿°')}</p>
                                    <p class="mb-1"><small><i class="bi bi-geo-alt"></i> ${escapeHtml(selectedFoundItem.found_location)}</small></p>
                                </div>
                            </div>
                        </div>
                    `;
                    selectedItemsDiv.innerHTML = html;
                    selectedItemsDiv.classList.remove('d-none');
                    matchBtn.disabled = false;
                } else {
                    selectedItemsDiv.classList.add('d-none');
                    matchBtn.disabled = true;
                }
            }

            // ç›‘å¬ä¸¢å¤±ç‰©å“é€‰æ‹©
            lostItemSelect.addEventListener('change', function() {
                const itemId = this.value;
                if (itemId) {
                    selectedLostItem = lostItemsCache.find(item => item.id === itemId);
                    displaySelectedItems();
                } else {
                    selectedLostItem = null;
                    displaySelectedItems();
                }
            });

            // ç›‘å¬æ‹›é¢†ç‰©å“é€‰æ‹©
            foundItemSelect.addEventListener('change', function() {
                const itemId = this.value;
                if (itemId) {
                    selectedFoundItem = foundItemsCache.find(item => item.id === itemId);
                    displaySelectedItems();
                } else {
                    selectedFoundItem = null;
                    displaySelectedItems();
                }
            });

            // å¼€å§‹åŒ¹é…
            matchBtn.addEventListener('click', async function() {
                if (!selectedLostItem || !selectedFoundItem) return;

                // æ˜¾ç¤ºåŠ è½½
                loading.classList.remove('d-none');
                noSelection.classList.add('d-none');
                matchResults.classList.add('d-none');
                matchBtn.disabled = true;
                matchSpinner.classList.remove('d-none');

                try {
                    // æ„å»ºè¯·æ±‚ä½“ - éœ€è¦ä¸¤ä¸ªç‰©å“ID
                    const requestBody = {
                        lost_item_id: selectedLostItem.id,
                        found_item_id: selectedFoundItem.id
                    };

                    console.log('å‘é€åŒ¹é…è¯·æ±‚:', requestBody);

                    const response = await fetch('/api/match', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    const data = await response.json();
                    console.log('åŒ¹é…ç»“æœ:', data);

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // æ˜¾ç¤ºåŒ¹é…ç»“æœ
                    displayMatchResult(data);

                } catch (error) {
                    console.error('åŒ¹é…å¤±è´¥:', error);
                    alert('åŒ¹é…å¤±è´¥: ' + error.message);
                } finally {
                    // éšè—åŠ è½½
                    loading.classList.add('d-none');
                    matchSpinner.classList.add('d-none');
                    matchBtn.disabled = false;
                }
            });

            // æ˜¾ç¤ºåŒ¹é…ç»“æœ
            function displayMatchResult(data) {
    // æ–°çš„åŒ¹é…ç»“æœæ˜¾ç¤º
    let html = `
        <div class="alert ${data.match_result.match_score > 50 ? 'alert-success' : 'alert-warning'}">
            <h6><i class="bi bi-search"></i> åŒ¹é…å®Œæˆ</h6>
            <p><strong>åŒ¹é…åˆ†æ•°ï¼š</strong> <span class="badge ${data.match_result.match_score > 50 ? 'bg-success' : 'bg-warning'} fs-6">${data.match_result.match_score}/100</span></p>
            <p><strong>åŒ¹é…ç­‰çº§ï¼š</strong> ${data.match_result.match_level}</p>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-danger text-white">
                        <i class="bi bi-exclamation-triangle"></i> ä¸¢å¤±ç‰©å“
                    </div>
                    <div class="card-body">
                        <h6>${escapeHtml(data.lost_item.title)}</h6>
                        <p class="text-muted">${escapeHtml(data.lost_item.description)}</p>
                        <p><small><i class="bi bi-geo-alt"></i> ${escapeHtml(data.lost_item.lost_location)}</small></p>
                        <p><small><i class="bi bi-calendar"></i> ${escapeHtml(data.lost_item.lost_date)}</small></p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-hand-thumbs-up"></i> æ‹›é¢†ç‰©å“
                    </div>
                    <div class="card-body">
                        <h6>${escapeHtml(data.found_item.title)}</h6>
                        <p class="text-muted">${escapeHtml(data.found_item.description)}</p>
                        <p><small><i class="bi bi-geo-alt"></i> ${escapeHtml(data.found_item.found_location)}</small></p>
                        <p><small><i class="bi bi-calendar"></i> ${escapeHtml(data.found_item.found_date)}</small></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <i class="bi bi-robot"></i> AIåˆ†æç»“æœ
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar ${data.match_result.match_score > 50 ? 'bg-success' : 'bg-warning'}"
                         style="width: ${data.match_result.match_score}%"
                         role="progressbar">
                        ${data.match_result.match_score}%
                    </div>
                </div>

                <p><strong>BERTè¯­ä¹‰åŒ¹é…åˆ†æ•°ï¼š</strong> ${data.match_result.bert_score}/100</p>
                <p><strong>AIåˆ†æï¼š</strong> ${escapeHtml(data.match_result.qianwen_analysis)}</p>
                <p><strong>å»ºè®®ï¼š</strong> ${data.match_result.match_score >= 60 ? 'ğŸ‰ å»ºè®®è”ç³»å¯¹æ–¹ç¡®è®¤' : 'ğŸ¤” éœ€è¦è¿›ä¸€æ­¥æ ¸å®'}</p>
            </div>
        </div>
    `;

    matchDetails.innerHTML = html;
    matchResults.classList.remove('d-none');
}

            // è®¡ç®—æè¿°ç›¸ä¼¼åº¦
            function calculateDescriptionSimilarity(desc1, desc2) {
                if (!desc1 || !desc2) return 0;

                const words1 = desc1.toLowerCase().split(/\s+/);
                const words2 = desc2.toLowerCase().split(/\s+/);

                const commonWords = words1.filter(word => words2.includes(word));
                const similarity = (commonWords.length / Math.max(words1.length, words2.length)) * 100;

                return Math.round(similarity);
            }

            // HTMLè½¬ä¹‰å‡½æ•°
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // åˆå§‹åŒ–
            loadItems();
        });
    </script>
</body>
</html>